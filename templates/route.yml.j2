api_version: route.openshift.io/v1
kind: Route
metadata:
  name: "{{ item.name | default(vm_name ~ '-route-' ~ item.service_port) }}"
  namespace: "{{ vm_namespace }}"
  labels:
    managed-by: ansible
spec:
  to:
    kind: Service
    name: "{{ item.service_name }}"
    weight: 100
  host: "{{ item.hostname }}"
{% if item.tls is defined %}
  tls:
{% for key, value in item.tls.items() %}
    {{ key }}: {{ value }}
{% endfor %}
{% endif %}
  port:
    targetPort: "{{ vm_services | selectattr('port', 'equalto', item.service_port) | map(attribute='target_port') | first }}"